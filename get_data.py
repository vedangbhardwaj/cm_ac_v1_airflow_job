import pandas as pd
#### importing Initial declaration ###
import initial_declaration as idc

query = """
    select  
        LOAN_ID,
        USER_ID,
        FULL_DATE,
        CALLED,
        FD_MONTH_YEAR,
        AUTO_CURE_FLAG,
        ROLL_FLAG,
        ASONDATE_DPD,
        LAST_DAY_DPD,
        NEXT_DAY_DPD,
        CITY,
        DAYS_SINCE_LAST_PAYMENT,
        DISPOSITION,
        AMOUNT,
        TOTAL_OUTSTANDING,
        INSTANCE_NUMBER,
        COLLECTIONS_WEEK,
        DISBURSAL_YM,
        EDI_PAID_ON_TIME_UNTIL_NOW,
        EDI_PAID_ON_TIME_LAST7DAYS,
        EDI_PAID_ON_TIME_LAST15DAYS,
        EDI_PAID_ON_TIME_LAST30DAYS,
        COLLECTIONS_EFFICIENCY_UNTIL_NOW,
        COLLECTIONS_EFFICIENCY_LAST7DAYS,
        COLLECTIONS_EFFICIENCY_LAST15DAYS,
        COLLECTIONS_EFFICIENCY_LAST30DAYS,
        ADJ_COLLECTIONS_EFFICIENCY_UNTIL_NOW,
        ADJ_COLLECTIONS_EFFICIENCY_LAST7DAYS,
        ADJ_COLLECTIONS_EFFICIENCY_LAST15DAYS,
        ADJ_COLLECTIONS_EFFICIENCY_LAST30DAYS,
        WENT_INTO_DPD1_LAST7_DAYS,
        WENT_INTO_DPD1_LAST15_DAYS,
        WENT_INTO_DPD1_LAST30_DAYS,
        WENT_INTO_DPD1_UNTIL_NOW,
        WENT_INTO_DPD1_PREVIOUSLY_LAST7_DAYS,
        WENT_INTO_DPD1_PREVIOUSLY_LAST15_DAYS,
        WENT_INTO_DPD1_PREVIOUSLY_LAST30_DAYS,
        WENT_INTO_DPD1_PREVIOUSLY,
        WENT_INTO_DPD2_LAST7_DAYS,
        WENT_INTO_DPD2_LAST15_DAYS,
        WENT_INTO_DPD2_LAST30_DAYS,
        WENT_INTO_DPD2_UNTIL_NOW,
        WENT_INTO_DPD2_PREVIOUSLY_LAST7_DAYS,
        WENT_INTO_DPD2_PREVIOUSLY_LAST15_DAYS,
        WENT_INTO_DPD2_PREVIOUSLY_LAST30_DAYS,
        WENT_INTO_DPD2_PREVIOUSLY,
        WENT_INTO_DPD3_LAST7_DAYS,
        WENT_INTO_DPD3_LAST15_DAYS,
        WENT_INTO_DPD3_LAST30_DAYS,
        WENT_INTO_DPD3_UNTIL_NOW,
        WENT_INTO_DPD3_PREVIOUSLY_LAST7_DAYS,
        WENT_INTO_DPD3_PREVIOUSLY_LAST15_DAYS,
        WENT_INTO_DPD3_PREVIOUSLY_LAST30_DAYS,
        WENT_INTO_DPD3_PREVIOUSLY,
        WENT_INTO_DPD4_LAST7_DAYS,
        WENT_INTO_DPD4_LAST15_DAYS,
        WENT_INTO_DPD4_LAST30_DAYS,
        WENT_INTO_DPD4_UNTIL_NOW,
        WENT_INTO_DPD4_PREVIOUSLY_LAST7_DAYS,
        WENT_INTO_DPD4_PREVIOUSLY_LAST15_DAYS,
        WENT_INTO_DPD4_PREVIOUSLY_LAST30_DAYS,
        WENT_INTO_DPD4_PREVIOUSLY,
        WENT_INTO_DPD5_LAST7_DAYS,
        WENT_INTO_DPD5_LAST15_DAYS,
        WENT_INTO_DPD5_LAST30_DAYS,
        WENT_INTO_DPD5_UNTIL_NOW,
        WENT_INTO_DPD5_PREVIOUSLY_LAST7_DAYS,
        WENT_INTO_DPD5_PREVIOUSLY_LAST15_DAYS,
        WENT_INTO_DPD5_PREVIOUSLY_LAST30_DAYS,
        WENT_INTO_DPD5_PREVIOUSLY,
        WENT_INTO_DPD10_LAST7_DAYS,
        WENT_INTO_DPD10_LAST15_DAYS,
        WENT_INTO_DPD10_LAST30_DAYS,
        WENT_INTO_DPD10_UNTIL_NOW,
        WENT_INTO_DPD10_PREVIOUSLY_LAST7_DAYS,
        WENT_INTO_DPD10_PREVIOUSLY_LAST15_DAYS,
        WENT_INTO_DPD10_PREVIOUSLY_LAST30_DAYS,
        WENT_INTO_DPD10_PREVIOUSLY,
        WENT_INTO_DPD10PLUS_LAST7_DAYS,
        WENT_INTO_DPD10PLUS_LAST15_DAYS,
        WENT_INTO_DPD10PLUS_LAST30_DAYS,
        WENT_INTO_DPD10PLUS_UNTIL_NOW,
        WENT_INTO_DPD10PLUS_PREVIOUSLY_LAST7_DAYS,
        WENT_INTO_DPD10PLUS_PREVIOUSLY_LAST15_DAYS,
        WENT_INTO_DPD10PLUS_PREVIOUSLY_LAST30_DAYS,
        WENT_INTO_DPD10PLUS_PREVIOUSLY,
        NACH_REPAYMENTS_UNTIL_NOW,
        UPLOAD_REPAYMENTS_UNTIL_NOW,
        MANUAL_REPAYMENTS_UNTIL_NOW,
        AUTO_REPAYMENTS_UNTIL_NOW,
        OFFLINE_SETTLEMENT_REPAYMENTS_UNTIL_NOW,
        TOTAL_REPAYMENTS_UNTIL_NOW,
        DAYS_AGO_INDPD1,
        DAYS_AGO_INDPD2,
        DAYS_AGO_INDPD3,
        DAYS_AGO_INDPD4,
        DAYS_AGO_INDPD5,
        DAYS_AGO_INDPD6,
        DAYS_AGO_INDPD7,
        DAYS_AGO_INDPD8,
        DAYS_AGO_INDPD9,
        DAYS_AGO_INDPD10,
        DAYS_AGO_INDPD10PLUS,
        CONSECUTIVELY_MOVED_TO_DPD2_UNTIL_NOW,
        CONSECUTIVELY_MOVED_TO_DPD2_UNTIL_NOW_FLAG,
        CONSECUTIVELY_MOVED_TO_DPD3_UNTIL_NOW,
        CONSECUTIVELY_MOVED_TO_DPD3_UNTIL_NOW_FLAG,
        CONSECUTIVELY_MOVED_TO_DPD2FROM1_UNTIL_NOW,
        CONSECUTIVELY_MOVED_TO_DPD2FROM1_UNTIL_NOW_FLAG,
        CONSECUTIVELY_MOVED_TO_DPD3FROM2_UNTIL_NOW,
        CONSECUTIVELY_MOVED_TO_DPD3FROM2_UNTIL_NOW_FLAG,
        CONSECUTIVELY_MOVED_TO_DPD6FROM2_UNTIL_NOW,
        CONSECUTIVELY_MOVED_TO_DPD6FROM2_UNTIL_NOW_FLAG,
        CONSECUTIVELY_MOVED_TO_DPD6FROM1_UNTIL_NOW,
        CONSECUTIVELY_MOVED_TO_DPD6FROM1_UNTIL_NOW_FLAG,
        CONSECUTIVELY_MOVED_TO_DPD11FROM6_UNTIL_NOW,
        CONSECUTIVELY_MOVED_TO_DPD11FROM6_UNTIL_NOW_FLAG,
        CONSECUTIVELY_MOVED_TO_DPD11FROM2_UNTIL_NOW,
        CONSECUTIVELY_MOVED_TO_DPD11FROM2_UNTIL_NOW_FLAG,
        CONSECUTIVELY_MOVED_TO_DPD11FROM1_UNTIL_NOW,
        CONSECUTIVELY_MOVED_TO_DPD11FROM1_UNTIL_NOW_FLAG,
        NO_OF_TOTAL_SMS,
        NO_OF_TOTAL_READABLE_SMS,
        MAX_TOTAL_DUE_AMOUNT_CC,
        MIN_TOTAL_DUE_AMOUNT_CC,
        MAX_AVAILABLE_LIMIT_CC,
        MIN_AVAILABLE_LIMIT_CC,
        NUM_CREDIT_TXNS_CC,
        NUM_DEBIT_TXNS_CC,
        TOTAL_CREDIT_AMOUNT_CC,
        MIN_CDT_AMT_CC,
        MAX_CDT_AMT_CC,
        TOTAL_DEBIT_AMOUNT_CC,
        MIN_DEBIT_AMOUNT_CC,
        MAX_DEBIT_AMOUNT_CC,
        MAX_AVAILABLE_BALANCE,
        MIN_AVAILABLE_BALANCE,
        TOTAL_AVAILABLE_BALANCE,
        NUM_AVAILABLE_BALANCE,
        NUM_CREDIT_TXNS,
        NUM_DEBIT_TXNS,
        TOTAL_CREDIT_AMOUNT,
        MIN_CDT_AMT,
        MAX_CDT_AMT,
        TOTAL_DEBIT_AMOUNT,
        MIN_DEBIT_AMOUNT,
        MAX_DEBIT_AMOUNT,
        TOTAL_DEBIT_COUNT_UPI,
        TOTAL_DEBIT_COUNT_ATM,
        TOTAL_DEBIT_COUNT_BANK_TRANSFER,
        TOTAL_DEBIT_COUNT_CHEQUE,
        TOTAL_DEBIT_COUNT_CASH,
        TOTAL_CREDIT_COUNT_UPI,
        TOTAL_CREDIT_COUNT_ATM,
        TOTAL_CREDIT_COUNT_BANK_TRANSFER,
        TOTAL_CREDIT_COUNT_CHEQUE,
        TOTAL_CREDIT_COUNT_CASH,
        TOTAL_CREDIT_AMOUNT_UPI,
        TOTAL_CREDIT_AMOUNT_ATM,
        TOTAL_CREDIT_AMOUNT_BANK_TRANSFER,
        TOTAL_CREDIT_AMOUNT_CHEQUE,
        TOTAL_CREDIT_AMOUNT_CASH,
        TOTAL_DEBIT_AMOUNT_UPI,
        TOTAL_DEBIT_AMOUNT_ATM,
        TOTAL_DEBIT_AMOUNT_BANK_TRANSFER,
        TOTAL_DEBIT_AMOUNT_CHEQUE,
        TOTAL_DEBIT_AMOUNT_CASH,
        NUM_CHEQUE_BOUNCES,
        NUM_NACH_BOUNCES,
        MIN_BALANCE_BREACH_FLAG,
        LOAN_DEFAULT_FLAG,
        CREDIT_CARD_OVERDUE_FLAG,
        LOAN_EMI_OVERDUE_FLAG,
        CREDIT_CARD_DEFAULT_FLAG,
        NUM_CHEQUE_BOUNCE_LAST7_DAYS,
        NUM_CHEQUE_BOUNCE_LAST15_DAYS,
        NUM_CHEQUE_BOUNCE_LAST30_DAYS,
        NUM_CHEQUE_BOUNCE_UNTIL_NOW,
        NUM_NACH_BOUNCE_LAST7_DAYS,
        NUM_NACH_BOUNCE_LAST15_DAYS,
        NUM_NACH_BOUNCE_LAST30_DAYS,
        NUM_NACH_BOUNCE_UNTIL_NOW,
        MIN_BALANCE_BREACH_LAST7_DAYS,
        MIN_BALANCE_BREACH_LAST15_DAYS,
        MIN_BALANCE_BREACH_LAST30_DAYS,
        MIN_BALANCE_BREACH_UNTIL_NOW,
        LOAN_DEFAULT_FLAG_LAST7_DAYS,
        LOAN_DEFAULT_FLAG_LAST15_DAYS,
        LOAN_DEFAULT_FLAG_LAST30_DAYS,
        LOAN_DEFAULT_FLAG_UNTIL_NOW,
        CREDIT_CARD_OVERDUE_FLAG_LAST7_DAYS,
        CREDIT_CARD_OVERDUE_FLAG_LAST15_DAYS,
        CREDIT_CARD_OVERDUE_FLAG_LAST30_DAYS,
        CREDIT_CARD_OVERDUE_FLAG_UNTIL_NOW,
        LOAN_EMI_OVERDUE_FLAG_LAST7_DAYS,
        LOAN_EMI_OVERDUE_FLAG_LAST15_DAYS,
        LOAN_EMI_OVERDUE_FLAG_LAST30_DAYS,
        LOAN_EMI_OVERDUE_FLAG_UNTIL_NOW,
        CREDIT_CARD_DEFAULT_FLAG_LAST7_DAYS,
        CREDIT_CARD_DEFAULT_FLAG_LAST15_DAYS,
        CREDIT_CARD_DEFAULT_FLAG_LAST30_DAYS,
        CREDIT_CARD_DEFAULT_FLAG_UNTIL_NOW,
        MIN_BALANCE_BREACH_FINAL_FLAG,
        LOAN_DEFAULT_FINAL_FLAG,
        CREDIT_CARD_OVERDUE_FINAL_FLAG,
        LOAN_EMI_OVERDUE_FINAL_FLAG,
        CREDIT_CARD_DEFAULT_FINAL_FLAG,
        SMS_NEGATIVE_FLAG_LAST7_DAYS,
        SMS_NEGATIVE_FLAG_LAST15_DAYS,
        SMS_NEGATIVE_FLAG_LAST30_DAYS,
        SMS_NEGATIVE_FLAG_UNTIL_NOW,
        BOUNCE_FLAG_LAST7_DAYS,
        BOUNCE_FLAG_LAST15_DAYS,
        BOUNCE_FLAG_LAST30_DAYS,
        BOUNCE_FLAG_UNTIL_NOW,
        MAX_EVER_DPD,
        TOTAL_EXPECTED_AMOUNT,
        LOAN_TYPE,
        USER_TYPE,
        VERIFICATION_TYPE,
        TENURE_DAYS,
        CREDIT_SCORE,
        RISK_BUCKET,
        TENURE_COMPLETED,
        UNSETTLED_TRXNS_3_BY_12,
        FULL_SETTLED_TRXNS_OVERALL_AVG_DAILY,
        UNSETTLED_TRXNS_OVERALL_AVG_MONTHLY,
        PARTIAL_SETTLED_TRXNS_3MNTH_AVG_DAILY,
        UNSETTLED_TRXNS,
        CREDIT_RECOVERED_3MNTH_AVG_DAILY,
        AMT_RECOVERED_0TO30_12MNTH_AVG_DAILY,
        AMT_RECOVERED_0TO30_6MNTH_AVG_DAILY,
        FULL_SETTLED_TRXNS_3MNTH_AVG_DAILY,
        AMT_RECOVERED_0TO30_3MNTH_AVG_DAILY,
        AMT_RECOVERED_31TO60_12MNTH_AVG_DAILY,
        CREDIT_RECOVERY_RATIO_3_BY_6,
        UNSETTLED_TRXNS_OVERALL_AVG_DAILY,
        UNSETTLED_TRXNS_3_BY_6,
        AMT_RECOVERED_31TO60_3_BY_6,
        CREDIT_RECOVERED_3_BY_12,
        PARTIAL_SETTLED_TRXNS_OVERALL_AVG_DAILY,
        AMT_RECOVERED_31TO60_OVERALL_AVG_MONTHLY,
        CREDIT_RECOVERY_RATIO_3_MNTH_AVG_DAILY,
        AMT_RECOVERED_31TO60_3_BY_12,
        AMT_RECOVERED_0TO30_3_BY_12,
        CREDIT_RECOVERED_OVERALL_AVG_DAILY,
        AMT_RECOVERED_31TO60_OVERALL_AVG_DAILY,
        AMT_RECOVERED_0TO30_3_BY_6,
        CREDIT_RECOVERY_RATIO_OVERALL_MNTH_AVG_MONTHLY,
        AMT_RECOVERED_31TO60_3MNTH_AVG_DAILY,
        DEBIT_AMNT,
        ACTIVATION_AGE,
        AVG_TRXNS_AMT_L3MONTH_DAILY,
        D_30_TXNS,
        AVG_DEBIT_TRXNS_CNT_L2MONTH_DAILY,
        KB_AGE,
        D_1_TXNS,
        NO_KB_CUSTOMERS,
        TOTAL_TXN_AMNT,
        ACTIVE_DAYS,
        CREDIT_AMNT,
        DAYS_SINCE_FIRST_CUST_ADDED,
        DAYS_SINCE_FIRST_TXN,
        TOTAL_CUSTOMERS,
        DAYS_SINCE_LAST_TXN,
        DEBIT_TRXNS,
        DAYS_SINCE_LAST_CUST_ADDED,
        CREDIT_EXTENDED_OVERALL_AVG_DAILY,
        CREDIT_TRXNS,
        AVG_TRXNS_CNT_L2MONTH_DAILY,
        AVG_TRXNS_AMT_L2MONTH_DAILY,
        TOTAL_TXN_MONTHS,
        AVG_CREDIT_TRXNS_CNT_L1MONTH_DAILY,
        AVG_CREDIT_TRXNS_CNT_L2MONTH_DAILY,
        AVG_CREDIT_TRXNS_CNT_L3MONTH_DAILY,
        AVG_DEBIT_TRXNS_CNT_L1MONTH_DAILY,
        CREDIT_EXTENDED_LAST_MONTH_VALUE,
        TOTAL_TRXNS
    from ANALYTICS.KB_ANALYTICS.AUTO_CURE_MODEL_FEATURE_BASE_JUN_UPDATED_V1_1 
    where date(FULL_DATE)>=date('{sd}')
    and date(FULL_DATE)<date('{ed}')
    """


cat_col=list(idc.feature_list['variables'][idc.feature_list['Type']=='Categorical'])
num_col=list(idc.feature_list['variables'][idc.feature_list['Type']=='Numerical'])
def var_type(var1):
    if var1 in cat_col:
        return "Categorical"
    elif var1 in num_col:
        return "Numerical"
    else:
        return "Others"


def missing_ind_convert_num(df):
    for var in df.columns:
        if(var_type(var)=="Numerical"):
            df[var]=pd.to_numeric(df[var])
            df[var]=df[var].fillna(idc.missing_value_num)            
    for var in df.columns:
        if(var_type(var)=="Categorical"):
            df[var]=df[var].fillna(idc.missing_value_cat)
            df[var]=df[var].replace('--',idc.missing_value_cat )
            df[var]=pd.Categorical(df[var])
    return df

def data_partition(df,date):
    df['FULL_DATE']=pd.to_datetime(df['FULL_DATE'])
    Train=df[df.FULL_DATE<=date]
    OOT=df[df.FULL_DATE>date]
    return Train, OOT